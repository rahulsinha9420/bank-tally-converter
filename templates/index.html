<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BankFlow - Secure Converter</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Poppins', sans-serif; overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 2.5rem; color: white; position: relative; z-index: 10;
        }
        .custom-input, .custom-select {
            background: rgba(255, 255, 255, 0.9); border: none; border-radius: 10px; padding: 12px; width: 100%; color: #333;
        }
        .btn-grad {
            background-image: linear-gradient(to right, #FF512F 0%, #DD2476 51%, #FF512F 100%);
            text-transform: uppercase; transition: 0.5s; background-size: 200% auto;
            color: white; border: none; border-radius: 10px; font-weight: bold; box-shadow: 0 0 20px #eee;
        }
        .btn-grad:hover { background-position: right center; color: #fff; transform: translateY(-3px); }
        .btn-grad:disabled { background-image: none; background-color: #999; cursor: not-allowed; }
        
        .upload-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1050; display: none;
            justify-content: center; align-items: center;
        }
        .upload-modal-overlay.show { display: flex; }
        .upload-modal {
            background: #fff; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; color: #333;
        }
        .drop-zone-modal {
            border: 2px dashed #ff9a9e; border-radius: 12px; padding: 40px 20px; text-align: center; background: #fffcfd; cursor: pointer;
        }
        .drop-zone-modal.dragover { border-color: #DD2476; background: rgba(221, 36, 118, 0.05); }
        
        /* FOOTER CREDIT */
        .footer-credit { 
            position: fixed; bottom: 20px; left: 0; width: 100%; text-align: center; 
            color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; z-index: 100; pointer-events: none; 
        }
        .footer-credit span { 
            color: #fff; font-weight: 700; text-shadow: 0 0 10px rgba(255, 255, 255, 0.4); 
        }
        #fileNameDisplay { background: white; color: #333; padding: 10px; border-radius: 10px; display: none; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="glass-card animate__animated animate__fadeInUp">
                    <div class="text-center mb-4">
                        <i class="fa-solid fa-shield-halved fa-3x mb-3 text-white"></i>
                        <h3 style="font-weight: 800;">Bank to Tally</h3>
                        <p>Securely Convert Statements to XML</p>
                    </div>
                    
                    <form id="convertForm">
                        <input type="hidden" name="password" id="hiddenPassword">
                        <div class="mb-3">
                            <label class="form-label text-white"><i class="fa-solid fa-list-check"></i> Type</label>
                            <select name="type" id="typeSelector" class="form-select custom-select">
                                <option value="bank" selected>Bank Statement</option>
                                <option value="sales" disabled>Sales Register (Soon)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-white"><i class="fa-solid fa-cloud-arrow-up"></i> Upload</label>
                            <input type="file" id="file" name="file" style="display:none;" required accept=".xlsx, .xls, .pdf">
                            <button type="button" class="btn btn-outline-light w-100" onclick="openUploadModal()">
                                <i class="fa-solid fa-plus me-2"></i> Choose File
                            </button>
                            <div id="fileNameDisplay"></div>
                            <div id="checkStatus" class="text-center text-white small mt-2"></div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-white">Bank Name (Tally)</label>
                            <input type="text" name="main_ledger" id="mainLedger" class="form-control custom-input" placeholder="e.g. IDFC Bank" required>
                        </div>
                        <button type="submit" id="submitBtn" class="btn btn-grad w-100 py-3" disabled>Convert Now</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="upload-modal-overlay" id="uploadModalOverlay">
        <div class="upload-modal">
            <div class="p-3 d-flex justify-content-between">
                <h5 class="mb-0">Upload File</h5>
                <button type="button" class="btn-close" onclick="closeUploadModal()"></button>
            </div>
            <div class="p-3">
                <div class="drop-zone-modal" id="modalDropZone" onclick="document.getElementById('file').click()">
                    <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2"></i>
                    <p>Click or Drop File</p>
                </div>
                <button class="btn btn-grad w-100 mt-3" onclick="closeUploadModal()" id="btnContinue" disabled>Continue</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="passwordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white"><h5>Password Detected</h5></div>
                <div class="modal-body"><input type="password" id="pdfPasswordInput" class="form-control" placeholder="Enter Password"></div>
                <div class="modal-footer"><button type="button" class="btn btn-danger" onclick="savePassword()">Unlock</button></div>
            </div>
        </div>
    </div>

    <div class="footer-credit animate__animated animate__fadeInUp animate__delay-1s">
        Designed with <i class="fa-solid fa-heart text-danger mx-1"></i> by <span>Rahul</span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const fileInput = document.getElementById('file');
        const modalDropZone = document.getElementById('modalDropZone');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const uploadModalOverlay = document.getElementById('uploadModalOverlay');
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        
        window.openUploadModal = () => uploadModalOverlay.classList.add('show');
        window.closeUploadModal = () => uploadModalOverlay.classList.remove('show');

        modalDropZone.addEventListener('dragover', (e) => { e.preventDefault(); modalDropZone.classList.add('dragover'); });
        modalDropZone.addEventListener('dragleave', () => modalDropZone.classList.remove('dragover'));
        modalDropZone.addEventListener('drop', (e) => {
            e.preventDefault(); modalDropZone.classList.remove('dragover');
            if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFile(fileInput.files[0]); });

        function handleFile(file) {
            const dt = new DataTransfer(); dt.items.add(file); fileInput.files = dt.files;
            fileNameDisplay.innerHTML = `<b>Selected:</b> ${file.name}`;
            fileNameDisplay.style.display = 'block';
            document.getElementById('btnContinue').disabled = false;
            checkLock();
            checkInputs();
        }

        function checkLock() {
            const formData = new FormData(); formData.append('file', fileInput.files[0]);
            fetch('/check_lock', { method: 'POST', body: formData })
            .then(r => r.json()).then(d => {
                if(d.status === 'locked') passwordModal.show();
            });
        }

        function savePassword() {
            document.getElementById('hiddenPassword').value = document.getElementById('pdfPasswordInput').value;
            passwordModal.hide();
        }

        document.getElementById('convertForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "Processing..."; btn.disabled = true;
            fetch('/convert', { method: 'POST', body: new FormData(this) })
            .then(r => {
                if(r.status === 401) { passwordModal.show(); throw new Error("Pass"); }
                return r.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url;
                a.download = fileInput.files[0].name.split('.')[0] + ".xml";
                a.click();
                location.reload();
            }).catch(() => { btn.innerHTML = "Convert Now"; btn.disabled = false; });
        });

        function checkInputs() { document.getElementById('submitBtn').disabled = !(document.getElementById('mainLedger').value && fileInput.files.length); }
        document.getElementById('mainLedger').addEventListener('input', checkInputs);
    </script>
</body>
</html>