<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BankFlow - Secure Converter</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            height: 100vh;
            display: flex; align-items: center; justify-content: center;
            font-family: 'Poppins', sans-serif; overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 2.5rem; color: white; position: relative; z-index: 10;
        }
        .custom-input, .custom-select {
            background: rgba(255, 255, 255, 0.9); border: none; border-radius: 10px; padding: 12px; width: 100%; color: #333;
        }
        .btn-grad {
            background-image: linear-gradient(to right, #FF512F 0%, #DD2476 51%, #FF512F 100%);
            text-transform: uppercase; transition: 0.5s; background-size: 200% auto;
            color: white; border: none; border-radius: 10px; font-weight: bold; box-shadow: 0 0 20px #eee;
        }
        .btn-grad:hover { background-position: right center; color: #fff; transform: translateY(-3px); }
        .btn-grad:disabled { background-image: none; background-color: #999; cursor: not-allowed; }
        
        /* Modals */
        .upload-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1050; display: none;
            justify-content: center; align-items: center;
        }
        .upload-modal-overlay.show { display: flex; }
        .upload-modal {
            background: #fff; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; color: #333;
        }
        .drop-zone-modal {
            border: 2px dashed #ff9a9e; border-radius: 12px; padding: 40px 20px; text-align: center; background: #fffcfd; cursor: pointer;
            transition: all 0.3s;
        }
        .drop-zone-modal:hover { background: #fff5f8; border-color: #DD2476; }
        .drop-zone-modal.dragover { background: rgba(221, 36, 118, 0.1); border-color: #DD2476; transform: scale(1.02); }
        
        .btn-continue {
            background-image: linear-gradient(to right, #FF512F 0%, #DD2476 51%, #FF512F 100%);
            color: white; border: none; border-radius: 8px; padding: 12px; width: 100%; font-weight: 600; margin-top: 24px;
        }
        .btn-continue:disabled { background: #e2e8f0; background-image: none; cursor: not-allowed; }
        .navbar-custom { background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); }
        
        /* Hidden Input Fix */
        .visually-hidden-input {
            position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; opacity: 0;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark fixed-top px-4 navbar-custom">
        <span class="navbar-brand mb-0 h1"><i class="fa-solid fa-shield-halved"></i> BankFlow</span>
    </nav>

    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="glass-card animate__animated animate__fadeInUp">
                    <div class="text-center mb-4">
                        <i class="fa-solid fa-file-invoice-dollar fa-3x mb-3 text-white"></i>
                        <h3 style="font-weight: 800;">Convert to Tally</h3>
                    </div>
                    
                    <form id="convertForm">
                        <input type="hidden" name="password" id="hiddenPassword">
                        
                        <div class="mb-3">
                            <label class="text-white mb-2">Conversion Type</label>
                            <select name="type" id="typeSelector" class="form-select custom-select">
                                <option value="bank" selected>Bank Statement</option>
                                <option value="sales" disabled>Sales Register (Coming Soon ðŸš€)</option>
                                <option value="purchase" disabled>Purchase Register (Coming Soon ðŸš€)</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="text-white mb-2">Upload File</label>
                            <input type="file" id="file" name="file" class="visually-hidden-input" required accept=".xlsx, .xls, .pdf">
                            <button type="button" class="btn btn-outline-light w-100 py-2" onclick="openUploadModal()" style="border-radius: 10px;">
                                <i class="fa-solid fa-plus me-2"></i> Choose File / Drag & Drop
                            </button>
                            <div id="fileNameDisplay" class="mt-2 p-2 bg-white rounded text-dark" style="display:none;"></div>
                            <div id="checkStatus" class="text-center text-white mt-2 small"></div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-white mb-2">Bank Name (As per Tally)</label>
                            <input type="text" name="main_ledger" id="mainLedger" class="form-control custom-input" placeholder="e.g. HDFC Bank" required>
                        </div>

                        <button type="submit" id="submitBtn" class="btn btn-grad btn-lg py-3 w-100" disabled>
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Convert Now
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="upload-modal-overlay" id="uploadModalOverlay">
        <div class="upload-modal">
            <div class="d-flex justify-content-between mb-3">
                <h5>Upload file</h5>
                <button type="button" class="btn-close" onclick="closeUploadModal()"></button>
            </div>
            
            <div class="drop-zone-modal" id="modalDropZone" onclick="document.getElementById('file').click()">
                <div id="dropZoneContent">
                    <i class="fa-solid fa-cloud-arrow-up fa-2x mb-2 text-secondary"></i>
                    <p>Drop files here or click to browse</p>
                </div>
            </div>
            
            <button class="btn-continue" onclick="closeUploadModal()" disabled id="btnContinue">Continue</button>
        </div>
    </div>

    <div class="modal fade" id="passwordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Password Protected</h5>
                </div>
                <div class="modal-body">
                    <p>Enter PDF Password:</p>
                    <input type="password" id="pdfPasswordInput" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="savePassword()">Unlock PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const fileInput = document.getElementById('file');
            const modalDropZone = document.getElementById('modalDropZone');
            const btnContinue = document.getElementById('btnContinue');
            const checkStatus = document.getElementById('checkStatus');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const uploadModalOverlay = document.getElementById('uploadModalOverlay');
            
            // Safe Modal Init
            let passwordModal;
            if(document.getElementById('passwordModal')) passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));

            // Exports
            window.openUploadModal = function() { uploadModalOverlay.classList.add('show'); };
            window.closeUploadModal = function() { uploadModalOverlay.classList.remove('show'); resetDragCounter(); };
            window.closeModal = function() { if(passwordModal) passwordModal.hide(); };
            
            window.savePassword = function() {
                const pwd = document.getElementById('pdfPasswordInput').value;
                document.getElementById('hiddenPassword').value = pwd;
                if(passwordModal) passwordModal.hide();
            };

            // === GLOBAL DRAG DETECTION ===
            let dragCounter = 0;
            function resetDragCounter() { dragCounter = 0; }

            document.body.addEventListener('dragenter', function(e) {
                e.preventDefault(); dragCounter++;
                if (dragCounter === 1) uploadModalOverlay.classList.add('show');
            });

            document.body.addEventListener('dragleave', function(e) {
                e.preventDefault(); dragCounter--;
            });
            
            document.body.addEventListener('dragover', function(e) { e.preventDefault(); });

            document.body.addEventListener('drop', function(e) {
                e.preventDefault(); resetDragCounter();
                if (uploadModalOverlay.classList.contains('show') && !modalDropZone.contains(e.target)) {
                     closeUploadModal();
                }
            });

            // === DROP ZONE LOGIC ===
            if(modalDropZone) {
                modalDropZone.addEventListener('dragenter', (e) => { e.preventDefault(); e.stopPropagation(); modalDropZone.classList.add('dragover'); });
                modalDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); modalDropZone.classList.add('dragover'); });
                modalDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); modalDropZone.classList.remove('dragover'); });
                
                modalDropZone.addEventListener('drop', (e) => {
                    e.preventDefault(); e.stopPropagation(); modalDropZone.classList.remove('dragover');
                    if(e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleFile(fileInput.files[0]); }
                });
            }

            if(fileInput) {
                fileInput.addEventListener('change', function() {
                    if (this.files.length > 0) handleFile(this.files[0]);
                });
            }

            function handleFile(file) {
                if(modalDropZone) {
                    modalDropZone.innerHTML = `<div class="animate__animated animate__bounceIn"><i class="fa-solid fa-circle-check text-success fa-3x mb-2"></i><h5 class="text-dark">${file.name}</h5><span class="badge bg-success">File Selected</span></div>`;
                    modalDropZone.style.borderColor = '#2ecc71';
                    modalDropZone.style.background = 'rgba(46, 204, 113, 0.1)';
                }
                if(btnContinue) btnContinue.disabled = false;
                if(fileNameDisplay) { fileNameDisplay.style.display = 'block'; fileNameDisplay.innerHTML = `<i class="fa-regular fa-file me-2"></i> ${file.name}`; }
                checkLock(file); checkInputs();
            }

            function checkLock(file) {
                const formData = new FormData(); formData.append('file', file);
                fetch('/check_lock', { method: 'POST', body: formData })
                .then(r => r.json()).then(d => {
                    if (d.status === 'locked') {
                        if(checkStatus) checkStatus.innerHTML = '<i class="fa-solid fa-lock text-danger"></i> Password Protected';
                        if(passwordModal) passwordModal.show();
                    } else { if(checkStatus) checkStatus.innerHTML = '<i class="fa-solid fa-check text-success"></i> File Ready'; }
                }).catch(err => console.log(err));
            }

            const form = document.getElementById('convertForm');
            if(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const btn = document.getElementById('submitBtn');
                    btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...'; btn.disabled = true;
                    
                    fetch('/convert', { method: 'POST', body: new FormData(this) })
                    .then(r => {
                        if (r.status === 401) { if(passwordModal) passwordModal.show(); throw new Error('Password Required'); }
                        if (!r.ok) throw new Error('Conversion Error');
                        return r.blob();
                    })
                    .then(blob => {
                        if(!blob) return;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url;
                        
                        // Dynamic Naming Logic
                        let originalName = "Converted.xml"; 
                        if(fileInput && fileInput.files.length > 0) {
                            originalName = fileInput.files[0].name.replace(/\.[^/.]+$/, "") + ".xml";
                        }
                        a.download = originalName;

                        document.body.appendChild(a); a.click(); a.remove();
                        setTimeout(() => location.reload(), 1000);
                    })
                    .catch(e => {
                        if(e.message !== 'Password Required') alert('Failed: ' + e.message);
                        btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Convert Now';
                    });
                });
            }

            const mainLedger = document.getElementById('mainLedger');
            if(mainLedger) mainLedger.addEventListener('input', checkInputs);

            function checkInputs() {
                const ledger = document.getElementById('mainLedger').value;
                const btn = document.getElementById('submitBtn');
                if(btn && fileInput) btn.disabled = !(ledger && fileInput.files.length > 0);
            }
        });
    </script>
</body>
</html>